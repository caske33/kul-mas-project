\documentclass[10pt,a4paper,twocolumn]{article}

\usepackage[english]{babel}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{graphicx}
\usepackage{todonotes}
\usepackage{url}

\title{Extensions on Contract Net Protocol for AGVs \\ \normalsize Multi-agent systems}

\author{Jens Claes \and Victor Le Pochat}

\date{June 3, 2016}

\newcommand{\proposalY}[1]{\todo[inline, color=green]{Proposal (by Yens): #1}}
\newcommand{\proposalV}[1]{\todo[inline, color=green]{Proposal (by Victor): #1}}

\newcommand{\commentY}[1]{\todo[inline, color=yellow]{Yens: "#1"}}
\newcommand{\commentV}[1]{\todo[inline, color=yellow]{Victor: "#1"}}

\newcommand{\taskY}[1]{\todo[inline, color=red]{@Yens, fix: #1}}
\newcommand{\taskV}[1]{\todo[inline, color=red]{@Victor, fix: #1}}
\newcommand{\taskS}[1]{\todo[inline, color=red]{@???, fix: #1}}

\newcommand{\outline}[1]{\todo[inline, caption={}, color=cyan]{\emph{Outline of what should come here}: #1}}

\graphicspath{ {./vpp/} }

\begin{document}
\maketitle

\commentY{In 2 kolommen? => geeft wel ander aantal pagina's, dus opletten met theorie sectie dan. Maar in mijn ogen is het wel een pak beter}

\section{Introduction}
\commentV{Zie https://bitbucket.org/VictorLP/mas/wiki/Notities}
\commentY{Normaal staan alle comments van de wiki in het verslag nu}
\subsection{Objectives}
\outline{\proposalV{Investigate the performance changes between DynCNET/confirmation and CNET. (bijbehorende question: what is the relative performance of cnet, confirmation and dyncnet)}}
The objective of this paper is to compare 2 extensions of Contract Net (CNET)\cite{CNETStandard,CNET}, namely Contract Net with Confirmation Protocol (CNCP)\cite{CNCP} and Dynamic Contract Net (DynCNET)\cite{DynCNET} to CNET itself. We do this in a drone delivery setting where all agents (both the drones and the clients) try to maximize (locally) the profit for the company. Drones can fail and are constrained by their batteries. They can charge these in the warehouses. The company needs to pay a fine for every client that is not delivered in time. The drones can pick up the packages in multiple warehouses (with infinite stock), each with a different price per package. Drones cannot collide with each other.

We investigate whether any of the aforementioned protocols are suited for a drone company to be profitable in the described setting. We will also check the influence of the number of drones, clients and warehouses on the profit the company can make.
\subsection{Hypotheses}
\commentY{Vraag-antwoord style of eerder voor doorlopende tekst gaan?}
\noindent\textit{Is there a difference between CNET, CNCP and DynCNET in the profit the company can make?} \\
We expect that the company can make more profit using DynCNET than using CNCP, which should be more profitable than CNET. \\

\noindent\textit{Is there a difference in average delivery time between CNET, CNCP and DynCNET?} \\
We expect that CNCP and CNET will deliver faster than DynCNET (as DynCNET wastes time when it switches). We don't expect a difference between CNCP and CNET as both will start delivering fast and won't waste any time by switching.\\

\noindent\textit{Is there a difference in the number of clients that are not delivered between CNET, CNCP and DynCNET?} \\
We expect that CNET and CNCP will deliver the same amount of clients and DynCNET less. Again because of the switching between clients.\\

\noindent\textit{Is there a difference in the number of messages that needs to be exchanged between CNET, CNCP and DynCNET?}\\
We expect that CNCP will need less messages because we expect less rounds of bidding. CNET will take more messages but still less than DynCNET which needs a lot of messages to make sure the best contract is being executed. \\

\noindent\textit{Is it possible to make a profit using any of the 3 approaches?}\\
We expect that all 3 approaches should be profitable give the right number of warehouses, drones and clients.\\

\noindent\textit{What is the influence of the number of drones on the profit?}\\
We expect the profit to scale linearly with the number of drones. Once all clients start to get delivered, saturation will set in.\\

\noindent\textit{What is the influence of the number of warehouses on the profit?}\\
We expect the profit to scale with the number of warehouses. As more warehouses become available, it will become more likely to have a warehouse with a low price for the product near the customer.\\

\noindent\textit{What is the influence of the number of clients on the profit?}\\
We expect the profit to rise until the fines of not delivering start to become too large.\\

\outline{In profit: DynCNET better than Confirmation better than CNET \\ In messages: CNET better than confirmation better than DynCNET}

\section{Theory}
\outline{Theoretische uiteenzetting van wat in de drie relevante papers staat}
In this section we describe how the theory of multi-agent systems map onto our implementation. We first discuss the agent architecture of the drone and the client. Then we discuss the theory of contract net and its variations in CNCP and DynCNET.

\commentY{Hoort sectie over agent architecture hier?}

\subsection{Agent Architecture} Both the drone and client agents have very simple architectures. They can be modeled using simple finite state machines. 

\commentY{FSM of toch proberen onderbrengen onder BDI/Reactive? BDI kan, maar hij probeert niet echt opnieuw (met lagere bieding) als hij intention heeft van bepaalde client. Al kunt ge zeggen dat intention pas is bij het binnenhalen van client. Reactive is er dan wrs weer te veel "state" voor.}

Figure~\ref{fig:droneFSM} gives the FSM for the drone agent in the different protocols\footnote{Not represented in the figure is the failed state, in case the drone crashes. It can enter this state from all other states and can never leave it again}. The \texttt{PROPOSED\_BID} state is only used in CNET, not in CNCP or DynCNET. In CNET and CNCP, a drone can bid in the green states. In DynCNET, a drone can bid in the green and yellow states. DynCNET also has two extra transitions: from \texttt{PICKING\_UP} and \texttt{CHARGING\_FOR\_CONTRACT} back to \texttt{IDLE} in case the client cancels the contract. CNCP and DynCNET also have the \texttt{gotContract} transition from \texttt{IDLE} and \texttt{CHARGING\_FOR\_CONTRACT} to \texttt{PICKING\_UP}, while in CNET the drone has to pass the \texttt{PROPOSED\_BID} state.

\begin{figure}[htp]
    \centering
    \includegraphics[width=0.5\textwidth]{Drone}
    \caption{A finite state machine of the drone agent (the black transitions and state only apply to CNET. The red transitions only to DynCNET and the green transitions only to CNCP and DynCNET)}
    \label{fig:droneFSM}
\end{figure}

The drone starts of in the \texttt{IDLE} state. In this state, it will move to the closet warehouse. When it gets there, it will enter the \texttt{CHARGING} state and start charging. In CNET, a drone will enter the \texttt{PROPOSED\_BID} state once it has sent a bid to a client. It will reenter the \texttt{IDLE} state if the client declines or the \texttt{PICKING\_UP} state when the client accepts. In the \texttt{PICKING\_UP} state it will start moving to the cheapest warehouse. When it gets there, it will start charging until it is sufficiently charged or it is time to leave (because the deadline of the client is coming up). Once it has entered the \texttt{DELIVERING} state, it will keep on flying to the client until it has arrived, upon which it will deliver the package to the client and enter the \texttt{IDLE} state.

\commentY{Ook FSM voor client beschrijven?}

\commentY{Ook "biedingen" beter op FSM weergeven? Of dat laten voor sequence diagram}

\taskS{Add sequence diagrams of 3 protocols (mss met kleuren werken om verschillen aan te duiden?). Best met zelfde kleuren als grafieken dan: CNET rood, CNCP groen en DynCNET blauw}

\subsection{Contract Net} The two types of agents in our solution each fulfill a different role in CNET: Clients fulfill the role of manager, while the drones fulfill the role of contractor. When clients enter the world, they will announce a call for proposal to all agents\footnote{This includes other clients, which will ignore all calls for proposals. RinSim does not (yet) provide a broadcast to a subset, the drones, of all agents.} through the means of broadcasting. This task announcement is simplified from the original paper \cite{CNET}, as all drones are eligible. No bid specification is provided, as this is known by the drones. There is also no expiration time, as drones should bid as quickly as they can.

When drones receive task announcements, they will calculate, for every warehouse, the estimated profit\footnote{Taking the delivery window and the probability of a crash into account} they can make on this client. Only the warehouse with maximal profit for the client is kept. This is done for all task announcements. A drone is only allowed to bid on 1 of those announcements, therefore the most profitable client is selected\footnote{If it is economically better to not deliver any client, no bids are placed}. A propose message is sent to this client including the estimated profit the company can make on this client. Once a drone has placed a bid, he will enter another state \texttt{PROPOSED\_BID} in which he is no longer allowed to bid until either he is awarded the task and has executed it or the client refuses his bid.

When a client receives a bid, it will compare it to the other bids it got (if any) and will award the contract to the drone which will make the most profit for the company \footnote{The client agent thus acts as if it is a manager for the real client}. It will send the drone a message to inform him of the contract. All other drones will be informed of the refusal of their proposal. If later on, more proposals would arrive, the client will refuse them. 

Because drones won't bid if it is not economically interesting, all bids are satisfactory for the client.

Once the drone has received the contract from the client, it will start executing it. Once it has picked up the package at the warehouse, it will inform the client of this. When it has delivered the package, it will also inform the client of this. In case the drone would crash, it would sent one last signal to the client to inform him of this failure\footnote{In practice, a polling approach might be used instead.}. This client would then send out a call for proposals again.

As said earlier, once a bid has been placed, a drone cannot bid unless the current task has been executed or he did not get the contract. While \cite{CNET} suggest that this might increase delay significantly, we assumed the effect would be smaller in our design where clients assign contracts from the moments they receive bids. As only 1 contract is possible, there is no need for a local scheduler within the drone.

To reduce the message count significantly, drones send explicit refuse messages to clients. In these messages, the reason for refusal is added. There are 3 possibilities: \texttt{BUSY}\footnote{The drone is executing another delivery}, \texttt{LOW\_RANKING}\footnote{The drone prefers the proposal of another client.} and \texttt{INELIGIBLE}\footnote{It is not economically profitable for the drone to deliver to this client}. Clients will act smart based on these refusal reasons. If a \texttt{LOW\_RANKING} is received, it can send a new call for proposal immediately as it is likely that a drone was refused the contract it preferred. If only \texttt{BUSY} or \texttt{INELIGIBLE} refusals are received, a new immediate call for proposal has little chance of succeeding. We know that the drones are busy delivering other packages or are too far away. Clients can thus wait until a drone becomes available again. \cite{CNET} suggests that drones could declare when they are available and what kind of tasks they can execute so the clients can propose them instead of the other way around. We decided to give extra information to the refusal message: If busy, the refusal message also contains a lower limit on when the drone will become available again. The client can now wait with sending out new calls for proposals until this lower limit has passed.

\subsection{Contract Net with Confirmation} The earlier solution suffers from 1 major flaw: drones have to commit to their bid until the client accepts or declines their bid. They are not allowed to bid on other task announcements while they have a bid outstanding. As their are $n$ drones and $m$ clients, $n*m$ bids are possible in theory. In practice, only $n$ bids are sent out. In the worst case, where all drones rank the clients in the same order $O(m)$ rounds of bidding are necessary to assign all clients to drones.

In CNCP, the drones are allowed to sent out multiple bids. Only when a drone receives an \texttt{AcceptProposal} message should it commit to the bid. It case it receives multiple bids, it can choose to which bid to commit. The client to which is committed is sent an \texttt{Agree} message. From that moment on, the drone starts executing the delivery\footnote{In \cite{CNCP} they first sent a \texttt{Request} message and only upon the \texttt{Agree} message of the client, the \texttt{AcceptProposal} is sent. These two messages from the client to the drone are merged together in our design}. All other clients are sent a \texttt{Disagree} message. When a client receives a \texttt{Disagree} message, it will send out a new call for proposal. This behaviour differs from \cite{CNCP}: when a client receives proposals, it will rank them and send out an \texttt{AcceptProposal} to the first one. If the first drone declines, the second drone will be sent an \texttt{AcceptProposal} and so on, until all (satisfactory) drones are sent an \texttt{AcceptProposal}. Because of the short deadlines and the high chance that the second drone has in the mean time committed to another client, we preferred to start a new bidding round.
\commentY{Disagree: note van dat dit een ACL-refuse message is? of via diagram?} 

While CNCP as described in \cite{CNCP} requires an extra $O(2*n)$ messages, our design only requires one extra message per bidding round. We believe the number of bidding rounds will be reduced drastically, and therefore the total message count as well (compared to CNET).

\subsection{Dynamic Contract Net} CNCP still suffers from one problem: while a drone is flying to the warehouse (and while he is charging in the warehouse before delivering the package), the world might change. Maybe another drone becomes available, or another client announces a new task. In both scenarios, it might be better to cancel the contract and start a new one. Neither CNET nor CNCP allow a drone or client to change a contract after they have committed to each other. In DynCNET, a drone can still cancel the contract, as long as it has not yet picked up the package in the warehouse. So if a better client comes along, a drone could cancel the old contract and start a new contract with this new client. Similarly, a client can break up the contract with a drone as long as this drone has not yet picked up the package. If a better drone becomes available (after it has delivered another package), the client might switch drones. It will let the old drone known that the contract has been canceled.

This means that in practice, the client will keep sending calls for proposals until the drone has picked up the package. Similarly, the drone will keep bidding on task announcements until it picks up the package. From then on, both agents are 100\% committed to the contract.

A potential risk of DynCNET is oscillation of tasks between drones. \cite{DynCNET} describes a solution by limiting the areas of interest. In our design, the agents are only limited by the battery constraint of the drones. We did not take special action to prevent the oscillation of tasks between drones.

\commentY{Message loss?}

\commentY{Synchronization van DynCNET: }
\commentV{This latter then sends a message to confirm the abort.
moeten we verbreken contract bevestigen? zie DynCNET + CW566: 3.3. Synchronization of abort messages}

\section{Multi-agent system design}
\outline{Wat wij concreet doen}
\subsection{Design}
\outline{\begin{itemize}
        \item drones leveren orders uit warehouses aan clients (1 order per client)
        \item bid berekening (statistisch relevant)
        \item messaging gedetailleerd bespreken of niet?
        \item tijd tijdens opladen wordt niet meegerekend bij estimated cost (footnote)
    \end{itemize}}
\subsection{Comparison with existing MAS from literature}
\outline{
    \begin{itemize}
        \item warehouses oneindige capaciteit
        \item tasks uit literature zijn orders bij ons
        \item verschillen in messaging
        \item concretere berekening bid
        \item hier de state machines? (of eerder bij design)
    \end{itemize}
    }
\commentY{\cite{TentativeBidding}, \cite{LeveledCommitment}, \cite{CNETIterativeStandard}, zie ook \cite{DynCNET} Related work voor korte beschrijving, \cite{CNETStandard} is ook nog niet besproken bij theorie + afwijking die bij theorie al voorkomen ook nog eens herhalen?}

\section{Experiments}
\subsection{Setup}
\outline{\begin{itemize}
        \item independent: aantal drones, warehouses, clients
        \item dependent: profit, aantal clients delivered, aantal messages, delivery time, ... (\texttt{ExperimentResult})
        \item other: battery drain, kost pakketjes, oplaadkost, ... (\texttt{Variables.kt} + \texttt{PackageType.kt})
    \end{itemize}}
\subsection{Results}
\commentY{Ook 95 \% Confidence interval (CI) op grafieken? Prof is daar precies fan van => Misschien beter om te doen. Ik ben niet 100\% zeker van correctheid, maar misschien wel, omdat het CI is van de variabele, niet het verschil tussen 2 variabelen. Dus zolang variabele normaal verdeeld is, is het waarschijnlijk wel ok.}
\subsection{Analysis}

\section{Conclusion}
\commentV{CW566: TABLE 1: INTERFACE DEFINITIONS FOR A TRANSPORT AGENT AND AN AGV AGENT
nakijken of we die allemaal hebben}
\commentY{Ook http://www.fipa.org/specs/fipa00037/SC00037J.html als referentie voor de ACL acts?}
\bibliographystyle{plain}
\bibliography{report}

\end{document}